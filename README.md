# Telegram-бот "Беспилотник"

Проект реализует Telegram-бота на базе `aiogram`, который автоматизирует приём экзаменов, техническую поддержку и фиксацию дефектов для парка беспилотных систем. Бот работает с PostgreSQL, локальным экземпляром Telegram Bot API (для приёма больших медиафайлов) и локальным файловым хранилищем, которое раздаётся через самого бота.

## Основные возможности
- **Онбординг пользователей** — отправка пошаговых подсказок со скриншотами, как включить автоудаление сообщений в Telegram.
- **Запись и приём экзаменов** — сбор заявок, сжатие видеороликов через FFmpeg до требуемого объёма, фиксация дат подачи и принятия.
- **Обращения в техподдержку** — создание заявок с медиа, ответы администраторов, запрос выезда специалиста и смена статусов.
- **Учёт ремонтов и замен** — хранение фото- и видеоматериалов по каждому серийному номеру, фиксация комментариев и результатов работ.
- **Раздача руководств** — загрузка актуальных документов администраторами и выдача пользователям по запросу.
- **Публичный доступ к медиа** — встроенный HTTP-обработчик `main.py` раздаёт файлы по пути `/files/...` из каталога `PUBLIC_MEDIA_ROOT`.

## Требования
- Python 3.11+
- PostgreSQL 13+
- Docker (для контейнера [`telegram-bot-api`](https://github.com/tdlib/telegram-bot-api))
- Установленный FFmpeg в `PATH` (используется библиотекой [`ffmpeg-python`](https://github.com/kkroening/ffmpeg-python))
- При необходимости: [ngrok](https://ngrok.com/) или иной reverse-proxy для публикации вебхука

## Подготовка окружения
1. Клонируйте репозиторий и создайте виртуальное окружение:
   ```bash
   git clone <URL_репозитория>
   cd BESPILOTNIK
   python3 -m venv venv
   source venv/bin/activate
   ```
2. Установите зависимости Python:
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
3. Скопируйте `.env.example` в `.env` и заполните все переменные окружения. Критично указать `BOT_TOKEN`, `BOT_MODE`, параметры PostgreSQL, публичный URL вебхука и настройки локального Telegram Bot API (если используется локальный режим).
4. Установите FFmpeg для вашей ОС и убедитесь, что команда `ffmpeg -version` работает в том же терминале.
5. Подготовьте PostgreSQL и создайте пользователя/базу из переменных окружения (`POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`). При запуске бот сам создаст и обновит таблицы.
6. При необходимости запустите локальный Telegram Bot API (подставьте свои `<API_ID>` и `<API_HASH>`):
   ```bash
   docker run -d --name telegram-bot-api \
     -p 8081:8081 \
     -v /opt/telegram-bot-api-data:/var/lib/telegram-bot-api \
     ghcr.io/tdlib/telegram-bot-api:latest \
       --api-id <API_ID> \
       --api-hash <API_HASH> \
       --http-port 8081 \
       --dir /var/lib/telegram-bot-api \
       --local
   ```
7. Поместите onboarding-скриншоты (`start1.jpg`, `start2.jpg`, `start3.jpg`) в каталог, указанный в `PUBLIC_MEDIA_ROOT`.

## Конфигурация
Все значения передаются через переменные окружения (`.env`). В `config.py` нет жёстко заданных путей или адресов, кроме вычисляемых значений на основе переданных переменных.

Ключевые переменные:
- `BOT_TOKEN` — токен бота из BotFather.
- `BOT_MODE` — режим работы (`PROD` для вебхука и локального Bot API, `DEVOPS` для опроса Telegram API).
- `NGROK_PUBLIC_URL` и `WEBHOOK_PATH` — формируют `WEBHOOK_URL` и `PUBLIC_MEDIA_URL`.
- `LOCAL_BOT_API_HOST`, `LOCAL_BOT_API_REMOTE_DIR`, `LOCAL_BOT_API_DATA_DIR`, `LOCAL_BOT_API_CACHE_DIR` — настройки локального Bot API и каталогов.
- `PUBLIC_MEDIA_ROOT` — корневой каталог публичных файлов; на его основе формируются подкаталоги `EXAM_*`, `DEFECT_MEDIA_DIR`, `MANUALS_STORAGE_DIR`, `VISITS_MEDIA_DIR`.
- `MAIN_ADMIN_IDS` — список Telegram ID администраторов.
- `POSTGRES_*` — параметры подключения к базе данных.

## Запуск
1. Убедитесь, что PostgreSQL и, при использовании локального API, контейнер Telegram Bot API запущены.
2. При необходимости пробросьте вебхук наружу: `ngrok http 8000`, затем обновите `NGROK_PUBLIC_URL`.
3. Запустите бота:
   ```bash
   source venv/bin/activate
   python main.py
   ```
При старте бот регистрирует вебхук, подключает middleware и поднимает HTTP-обработчик для раздачи файлов из `PUBLIC_MEDIA_ROOT`.

## Хранение данных и отчёты
- Все медиафайлы сохраняются в каталоги, указанные в `config.py`, и доступны по ссылкам `/files/...`.
- Записи об экзаменах автоматически содержат дату подачи заявки и дату принятия решения.
- Административные выгрузки (Excel) включают соответствующие временные метки и доступны из inline-меню.

## Диагностика
- При проблемах с загрузкой больших видео проверьте доступность локального Bot API и корректность `LOCAL_BOT_API_DATA_DIR`.
- Если в логах появляется предупреждение об отсутствии `ffmpeg`, установите бинарник и добавьте его в `PATH`.
- Быструю проверку синтаксиса перед деплоем можно выполнить командой `python -m compileall .`.

## Структура проекта
```
BESPILOTNIK/
├── config.py                # Конфигурация окружения
├── main.py                  # Точка входа и запуск вебхука
├── handlers/                # Маршрутизаторы и обработчики aiogram
├── database/                # Схема и функции работы с PostgreSQL
├── keyboards/               # Построение inline-клавиатур
├── utils/                   # Сжатие видео и вспомогательные функции хранения
├── data/                    # Публичное хранилище (скриншоты, медиа)
└── requirements.txt         # Список зависимостей Python
```
