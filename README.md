# Telegram-бот "Беспилотник"

Проект реализует Telegram-бота на базе `aiogram`, который автоматизирует приём экзаменов, техническую поддержку и фиксацию дефектов для парка беспилотных систем. Бот работает с PostgreSQL, локальным экземпляром Telegram Bot API (для приёма больших медиафайлов) и локальным файловым хранилищем, которое раздаётся через самого бота.

## Основные возможности
- **Онбординг пользователей** — отправка пошаговых подсказок со скриншотами, как включить автоудаление сообщений в Telegram.
- **Запись и приём экзаменов** — сбор заявок, сжатие видеороликов через FFmpeg до требуемого объёма, фиксация дат подачи и принятия.
- **Обращения в техподдержку** — создание заявок с медиа, ответы администраторов, запрос выезда специалиста и смена статусов.
- **Учёт ремонтов и замен** — хранение фото- и видеоматериалов по каждому серийному номеру, фиксация комментариев и результатов работ.
- **Раздача руководств** — загрузка актуальных документов администраторами и выдача пользователям по запросу.
- **Публичный доступ к медиа** — встроенный HTTP-обработчик `main.py` раздаёт файлы по пути `/files/...` из каталога `PUBLIC_MEDIA_ROOT`.

## Требования
- Python 3.11+
- PostgreSQL 13+
- Docker (для контейнера [`telegram-bot-api`](https://github.com/tdlib/telegram-bot-api))
- Установленный FFmpeg в `PATH` (используется библиотекой [`ffmpeg-python`](https://github.com/kkroening/ffmpeg-python))
- При необходимости: [ngrok](https://ngrok.com/) или иной reverse-proxy для публикации вебхука

## Подготовка окружения
1. Клонируйте репозиторий и создайте виртуальное окружение:
   ```bash
   git clone <URL_репозитория>
   cd BESPILOTNIK
   python3 -m venv venv
   source venv/bin/activate
   ```
2. Установите зависимости Python:
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```
3. Установите FFmpeg для вашей ОС и убедитесь, что команда `ffmpeg -version` работает в том же терминале.
4. Подготовьте PostgreSQL и создайте пользователя/базу, указанные в `config.py` (по умолчанию база `musorok`, пользователь `postgres`, пароль `Merryweather4670!`). При запуске бот сам создаст и обновит таблицы.
5. Запустите локальный Telegram Bot API (подставьте свои `<API_ID>` и `<API_HASH>`):
   ```bash
   docker run -d --name telegram-bot-api \
     -p 8081:8081 \
     -v /opt/telegram-bot-api-data:/var/lib/telegram-bot-api \
     ghcr.io/tdlib/telegram-bot-api:latest \
       --api-id <API_ID> \
       --api-hash <API_HASH> \
       --http-port 8081 \
       --dir /var/lib/telegram-bot-api \
       --local
   ```
6. Поместите onboarding-скриншоты (`start1.jpg`, `start2.jpg`, `start3.jpg`) в каталог, указанный в `PUBLIC_MEDIA_ROOT` (по умолчанию `data/`).

## Конфигурация
Перед запуском откройте `config.py` и задайте ключевые параметры:
- `TOKEN` — токен бота из BotFather.
- `NGROK_PUBLIC_URL` — HTTPS-адрес внешнего туннеля; `WEBHOOK_URL` формируется автоматически.
- `LOCAL_BOT_API_HOST`, `LOCAL_BOT_API_REMOTE_DIR`, `LOCAL_BOT_API_DATA_DIR`, `LOCAL_BOT_API_CACHE_DIR` — настройки доступа к локальному Bot API и каталогу с файлами.
- `PUBLIC_MEDIA_ROOT` / `PUBLIC_MEDIA_URL` — путь к каталогу, откуда будут раздаваться файлы, и базовый публичный URL.
- `EXAM_VIDEOS_DIR`, `EXAM_PHOTOS_DIR`, `DEFECT_MEDIA_DIR`, `MANUALS_STORAGE_DIR` — подкаталоги для разных типов материалов.
- `DB_CONFIG` — параметры подключения к PostgreSQL, если отличаетесь от значений по умолчанию.
- `MAIN_ADMIN_IDS` — список Telegram ID администраторов.

## Запуск
1. Убедитесь, что PostgreSQL и контейнер Telegram Bot API запущены.
2. При необходимости пробросьте вебхук наружу: `ngrok http 8000`, затем обновите `NGROK_PUBLIC_URL`.
3. Запустите бота:
   ```bash
   source venv/bin/activate
   python main.py
   ```
При старте бот регистрирует вебхук, подключает middleware и поднимает HTTP-обработчик для раздачи файлов из `PUBLIC_MEDIA_ROOT`.

## Хранение данных и отчёты
- Все медиафайлы сохраняются в каталоги, указанные в `config.py`, и доступны по ссылкам `/files/...`.
- Записи об экзаменах автоматически содержат дату подачи заявки и дату принятия решения.
- Административные выгрузки (Excel) включают соответствующие временные метки и доступны из inline-меню.

## Диагностика
- При проблемах с загрузкой больших видео проверьте доступность локального Bot API и корректность `LOCAL_BOT_API_DATA_DIR`.
- Если в логах появляется предупреждение об отсутствии `ffmpeg`, установите бинарник и добавьте его в `PATH`.
- Быструю проверку синтаксиса перед деплоем можно выполнить командой `python -m compileall .`.

## Структура проекта
```
BESPILOTNIK/
├── config.py                # Конфигурация окружения
├── main.py                  # Точка входа и запуск вебхука
├── handlers/                # Маршрутизаторы и обработчики aiogram
├── database/                # Схема и функции работы с PostgreSQL
├── keyboards/               # Построение inline-клавиатур
├── utils/                   # Сжатие видео и вспомогательные функции хранения
├── data/                    # Публичное хранилище (скриншоты, медиа)
└── requirements.txt         # Список зависимостей Python
```
